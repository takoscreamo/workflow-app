# ワークフローアプリケーション - バックエンド課題実装タスク

## 🎯 必須要件（最優先で実装）

### 1. データストアによるデータ永続化
- [x] `Workflow`モデルとマイグレーション作成
  - `id`, `name` フィールド
- [x] `Node`モデルとマイグレーション作成
  - `id`, `workflow_id`, `node_type`, `config`（JSON）フィールド
- [x] データベースリレーション設定（Workflow hasMany Node）
- [x] 初期データのシーダー作成

### 2. 非同期処理によるWorkflow実行
- [x] `RunWorkflowJob`作成（Laravel Queue使用）
- [x] `RunNodeJob`作成（各ノード処理用）
- [x] Queue設定（Redis使用）
- [x] ジョブチェーン実装（`dispatch()->chain()`）
- [x] ワークフロー実行エンドポイントの非同期化

### 3. NodeType.GENERATIVE_AIの実装
- [x] LLM API連携機能実装（OpenRouter API使用）
- [x] プロンプト設定機能
- [x] モデル選択機能
- [x] その他のパラメータ設定機能
- [x] `generative_ai`ノード処理クラス作成

### 4. NodeType.FORMATTERの実装
- [x] テキスト整形機能実装
  - 大文字を小文字にする
  - 小文字を大文字にする
  - 半角を全角にする
  - 全角を半角にする
- [x] フォーマットルール設定機能
- [x] `formatter`ノード処理クラス作成

### 5. PDFファイルアップロード機能
- [x] PDFファイルアップロードエンドポイント実装
- [x] ファイル保存設定
- [x] ファイルバリデーション
- [x] NodeType.EXTRACT_TEXTの実装
  - `spatie/pdf-to-text`パッケージ使用
  - PDFからテキスト抽出機能

## 🔧 基本APIエンドポイント実装

### 1. ワークフロー管理API
- [x] `WorkflowController`作成
- [x] `POST /api/workflows` - ワークフロー作成
- [x] `GET /api/workflows/{id}` - ワークフロー取得
- [x] `PUT /api/workflows/{id}` - ワークフロー更新
- [x] `DELETE /api/workflows/{id}` - ワークフロー削除
- [x] `POST /api/workflows/{id}/nodes` - ノード追加
- [x] `POST /api/workflows/{id}/run` - ワークフロー実行（非同期処理）
- [x] `GET /api/workflows/execution/{sessionId}` - 実行状況取得

### 2. ファイルアップロードAPI
- [x] `FileController`作成
- [x] `POST /api/files/upload` - PDFファイルアップロード

### 3. リクエスト・レスポンスクラス
- [x] `CreateWorkflowDTO`作成
- [x] `UpdateWorkflowDTO`作成
- [x] `AddNodeDTO`作成
- [x] `WorkflowDetailResponse`作成

## 🏗️ アーキテクチャ実装

### 1. オニオンアーキテクチャ
- [x] Domain層（エンティティ、リポジトリインターフェース）
- [x] Usecase層（DTOs、ユースケース）
- [x] Infrastructure層（Eloquentモデル、リポジトリ実装）
- [x] Presentation層（コントローラー）
- [x] 依存性注入の設定

### 2. ドメイン駆動設計
- [x] `Workflow`エンティティ作成
- [x] `Node`エンティティ作成
- [x] `NodeType`列挙型作成
- [x] リポジトリパターン実装

## 🎨 フロントエンド実装（Next.js）

### 1. 基本構造
- [x] API通信ラッパー作成（`lib/api.ts`）
- [x] 型定義作成（`types/`）
  - `Workflow`, `Node`, `NodeType`インターフェース
  - リクエスト・レスポンス型定義

### 2. ページ実装
- [x] ワークフロー一覧画面（作成・編集・削除・実行）
- [x] ワークフロー詳細画面（ノード追加・一覧）
- [x] ノード設定画面（各ノードタイプ用）
- [x] 実行結果表示画面

### 3. コンポーネント実装
- [x] ワークフロー作成フォーム
- [x] ノード追加コンポーネント
- [x] ノード設定フォーム
  - `generative_ai`用（プロンプト、モデル設定）
  - `formatter`用（フォーマットルール設定）
- [x] ファイルアップロードコンポーネント
- [x] 実行ボタン・ステータス表示（非同期処理対応）

## 🔗 API連携・統合

### 1. フロントエンドとバックエンド連携
- [x] API通信ラッパー実装
- [x] エラーハンドリング
- [x] ローディング状態管理
- [x] CORS設定最終調整

### 2. 非同期処理のフロントエンド対応
- [x] ワークフロー実行状況の監視
- [x] 実行結果の取得・表示

## 🧪 テスト実装

### 1. バックエンドテスト
- [x] 基本的なテスト環境構築（PHPUnit設定）
- [x] `FormatterNodeProcessorTest`実装
  - 全角・半角変換テスト
  - 大文字・小文字変換テスト
  - フォーマットタイプ未指定時のテスト
- [x] `MbConvertKanaTest`実装
  - mb_convert_kana関数の各オプションテスト
  - 組み合わせテスト
- [x] `GenerativeAiNodeProcessorTest`実装
  - API通信テスト（Http::fake使用）
  - エラーハンドリングテスト
  - パラメータ設定テスト
- [x] `QueueSystemTest`実装
  - ジョブディスパッチテスト
  - リトライ・タイムアウト設定テスト
  - キャッシュ統合テスト
- [x] `TestJob`実装（Queueシステムテスト用）
- [x] テスト用コマンド実装（`test:queue`）
- [x] `WorkflowTest`実装（Featureテスト）
  - ワークフローCRUD操作のテスト
  - ノード追加テスト
  - バリデーションテスト
- [x] `FileUploadTest`実装（Featureテスト）
  - ファイルアップロードテスト
  - バリデーションテスト
  - セキュリティテスト
- [x] `AsyncWorkflowTest`実装（Featureテスト）
  - 非同期処理テスト
  - 実行状況監視テスト
  - エラーハンドリングテスト
- [x] 統合テスト（Featureテストとして実装）

### 2. フロントエンドテスト
- [ ] コンポーネントテスト
- [ ] API通信のテスト

### 3. 統合テスト
- [x] ワークフロー実行の統合テスト（AsyncWorkflowTestとして実装済み）
- [x] ファイルアップロード統合テスト（FileUploadTestとして実装済み）

## 📚 ドキュメント

### 1. README更新
- [x] セットアップ・起動方法
- [x] エンドポイント仕様
- [x] アーキテクチャ説明
- [x] 実装状況の反映
- [x] Makefileコマンドの追加

### 2. API仕様書
- [x] エンドポイント詳細ドキュメント
- [x] リクエスト・レスポンス例
- [x] エラーコード一覧
- [x] ノードタイプ詳細説明
- [x] 非同期処理の仕組み説明

### 3. 開発者ガイド
- [x] 開発環境セットアップ
- [x] アーキテクチャ詳細説明
- [x] 開発フロー
- [x] テスト戦略
- [x] 主要ファイル説明

### 4. Makefile
- [x] 環境構築コマンド
- [x] テスト実行コマンド
- [x] アプリケーション管理コマンド
- [x] データベース操作コマンド
- [x] クリーンアップコマンド

## 🚀 オプション機能（将来の拡張）

### 1. DAG（有向非巡回グラフ）構造
- [ ] 複数の入力・出力対応
- [ ] ノード間の依存関係管理
- [ ] グラフ構造の可視化

### 2. AIエージェントノード
- [ ] 達成条件設定機能
- [ ] タスクプランニング機能
- [ ] 必要なツール判断機能
- [ ] 終了条件自動判断機能

### 3. 認証・認可機能
- [ ] ユーザー管理システム
- [ ] ロールベースアクセス制御
- [ ] API認証（JWT等）

### 4. 本番環境対応
- [ ] 本番データベース（PostgreSQL/MySQL）
- [ ] 本番Redis設定
- [ ] ロードバランサー設定
- [ ] 監視・ログシステム

### 5. パフォーマンス最適化
- [ ] キャッシュ戦略
- [ ] データベースインデックス最適化
- [ ] フロントエンド最適化
- [ ] CDN設定

---

## 📊 進捗管理

### 現在の状況
- ✅ Docker環境構築完了
- ✅ Laravel 11 + Next.js 13+ セットアップ完了
- ✅ 基本的なアプリケーション起動確認完了
- ✅ オニオンアーキテクチャ実装完了
- ✅ データベース設計・マイグレーション実装完了
- ✅ 基本APIエンドポイント実装完了
- ✅ フロントエンド基本画面実装完了
- ✅ **Phase 2**: 3つのノードタイプ実装完了（FORMATTER → EXTRACT_TEXT → GENERATIVE_AI）
- ✅ **Phase 3**: 非同期処理実装完了（Laravel Queue + Redis）
- ✅ **Phase 4**: テスト実装完了（ユニットテスト・Featureテスト・統合テスト）
- ✅ **Phase 5**: ドキュメント完成（Makefile、API仕様書、開発者ガイド）

### 実装優先順位
1. ✅ **Phase 1**: 基本画面実装、動作確認、データベース設計、マイグレーション実装
2. ✅ **Phase 2**: 3つのノードタイプ実装（FORMATTER → EXTRACT_TEXT → GENERATIVE_AI）
3. ✅ **Phase 3**: 非同期処理実装（Laravel Queue + Redis）
4. ✅ **Phase 4**: テスト実装（完了）
5. ✅ **Phase 5**: ドキュメント完成（完了）

---

## 📝 実装メモ

### 技術スタック
- **バックエンド**: Laravel 11, PHP 8.2, SQLite（開発環境）, Redis 7
- **フロントエンド**: Next.js 13+, TypeScript, Tailwind CSS
- **アーキテクチャ**: オニオンアーキテクチャ（クリーンアーキテクチャ）
- **非同期処理**: Laravel Queue + Redis（実装済み）
- **PDF処理**: spatie/pdf-to-text（実装済み）
- **LLM API**: OpenRouter API（実装済み）
- **テスト**: PHPUnit（実装済み）
- **ドキュメント**: Markdown形式（API仕様書、開発者ガイド）

### 重要な実装ポイント
- ✅ ノードの`config`はJSON形式で保存し、各ノードタイプ固有の設定を管理
- ✅ ワークフロー実行は必ず非同期処理で実装
- ✅ ファイルアップロードは適切なバリデーションを実装
- ✅ エラーハンドリングを各層で適切に実装
- ✅ テスト環境の構築と基本的なユニットテスト実装
- ✅ ドキュメント完成とMakefileによる開発効率化

### アーキテクチャ詳細
- **Domain層**: ビジネスロジックの中心、外部依存なし
- **Usecase層**: アプリケーションのユースケース、DTOs
- **Infrastructure層**: 外部依存（DB、API等）の実装
- **Presentation層**: HTTPリクエストの処理
- **Queue層**: 非同期ジョブ処理
- **Test層**: ユニットテスト・統合テスト
- **Document層**: API仕様書、開発者ガイド、Makefile

### 実装完了済み機能
1. ✅ **FORMATTER** - テキスト整形機能（大文字化・小文字化・全角変換・半角変換）
2. ✅ **EXTRACT_TEXT** - PDFファイルアップロード・テキスト抽出
3. ✅ **GENERATIVE_AI** - OpenRouter API連携（プロンプト・モデル・パラメータ設定）
4. ✅ **ファイルアップロード** - PDFファイルアップロード機能
5. ✅ **PDF出力** - TCPDFライブラリで日本語対応PDF生成
6. ✅ **非同期処理** - Laravel Queue + Redisによる非同期ワークフロー実行
7. ✅ **実行状況監視** - フロントエンドでの実行状況ポーリング
8. ✅ **エラーハンドリング** - ジョブ失敗時の適切な処理
9. ✅ **ローディング状態** - 実行中のUI表示とボタン無効化
10. ✅ **テスト環境** - PHPUnit設定と基本的なユニットテスト実装
11. ✅ **ドキュメント** - API仕様書、開発者ガイド、Makefile

### Phase 3実装詳細
- **RunWorkflowJob**: ワークフロー実行専用ジョブクラス
- **セッション管理**: 実行結果の一時保存と取得
- **ポーリング機能**: 1秒間隔での実行状況確認
- **タイムアウト設定**: 5分の実行タイムアウト
- **リトライ機能**: 最大3回のリトライ
- **エラーハンドリング**: ジョブ失敗時の適切な処理
- **フロントエンド対応**: 実行中のUI表示とボタン無効化

### Phase 4実装詳細（完了）
- **テスト環境構築**: PHPUnit設定完了
- **FormatterNodeProcessorTest**: フォーマッターノードの全機能テスト
- **MbConvertKanaTest**: mb_convert_kana関数の詳細テスト
- **GenerativeAiNodeProcessorTest**: AIノードのAPI通信・エラーハンドリングテスト
- **QueueSystemTest**: Queueシステムの全機能テスト
- **WorkflowTest**: ワークフローCRUD操作のFeatureテスト
- **FileUploadTest**: ファイルアップロードのFeatureテスト
- **AsyncWorkflowTest**: 非同期処理のFeatureテスト
- **TestJob**: Queueシステムテスト用ジョブ
- **テストコマンド**: `test:queue`コマンドでQueue動作確認
- **テスト実行**: `php artisan test`でテスト実行可能
- **テストカバレッジ**: ユニットテスト・Featureテスト・統合テストを網羅

### Phase 5実装詳細（完了）
- **Makefile**: 開発効率化のためのコマンド集
  - 環境構築コマンド（`make setup`, `make install-deps`）
  - アプリケーション管理コマンド（`make start`, `make stop`, `make restart`）
  - テスト実行コマンド（`make test`, `make test-unit`, `make test-feature`）
  - データベース操作コマンド（`make migrate`, `make seed`, `make db-reset`）
  - クリーンアップコマンド（`make clean`, `make cache-clear`）
  - 開発用コマンド（`make backend-shell`, `make frontend-shell`）
- **API仕様書（API.md）**: バックエンドAPIの詳細仕様
  - 全エンドポイントの詳細仕様
  - リクエスト・レスポンス例
  - エラーコード一覧
  - ノードタイプ詳細説明
  - 非同期処理の仕組み説明
  - 開発者向け情報
- **開発者ガイド（DEVELOPER_GUIDE.md）**: 開発者向けガイド
  - 開発環境セットアップ手順
  - オニオンアーキテクチャ詳細説明
  - 開発フロー
  - テスト戦略
  - 主要ファイル説明
  - 設定ファイル詳細
- **README更新**: プロジェクト概要の更新
  - Makefileコマンドの追加
  - 簡単セットアップ手順の追加
  - ドキュメントへのリンク追加
  - プロジェクト完了状況の更新

---

## 🎉 プロジェクト完了総括

### ✅ 全機能実装完了

Workflow Appの全機能が実装完了しました！

#### 実装完了機能一覧
1. **🏗️ アーキテクチャ**
   - ✅ オニオンアーキテクチャ（クリーンアーキテクチャ）
   - ✅ ドメイン駆動設計
   - ✅ 依存性注入
   - ✅ レイヤー分離（Domain, Usecase, Infrastructure, Presentation）

2. **🔧 バックエンド機能**
   - ✅ Laravel 11 + PHP 8.2
   - ✅ SQLiteデータベース（開発環境）
   - ✅ Redis 7（キャッシュ・キュー）
   - ✅ Docker環境構築

3. **🎨 フロントエンド機能**
   - ✅ Next.js 13+ + TypeScript
   - ✅ Tailwind CSS
   - ✅ App Router
   - ✅ レスポンシブデザイン

4. **⚙️ ノード処理システム**
   - ✅ FORMATTER（テキスト整形）
   - ✅ EXTRACT_TEXT（PDFテキスト抽出）
   - ✅ GENERATIVE_AI（AI処理）
   - ✅ ファクトリーパターン実装

5. **🔄 非同期処理システム**
   - ✅ Laravel Queue + Redis
   - ✅ RunWorkflowJob
   - ✅ 実行状況監視
   - ✅ エラーハンドリング・リトライ機能

6. **📁 ファイル管理**
   - ✅ PDFファイルアップロード
   - ✅ ファイルバリデーション
   - ✅ 安全なファイル保存
   - ✅ PDF出力機能

7. **🧪 テスト環境**
   - ✅ PHPUnit設定
   - ✅ ユニットテスト（FormatterNodeProcessorTest, GenerativeAiNodeProcessorTest等）
   - ✅ Featureテスト（WorkflowTest, FileUploadTest, AsyncWorkflowTest）
   - ✅ 統合テスト
   - ✅ Queueシステムテスト

8. **📚 ドキュメント**
   - ✅ README.md（プロジェクト概要）
   - ✅ API.md（API仕様書）
   - ✅ DEVELOPER_GUIDE.md（開発者ガイド）
   - ✅ TASK.md（タスク管理）
   - ✅ Makefile（開発用コマンド集）

### 🚀 技術的成果

#### アーキテクチャ設計
- **オニオンアーキテクチャ**による保守性の高い設計
- **ドメイン駆動設計**によるビジネスロジックの明確化
- **依存性注入**によるテスタビリティの向上
- **レイヤー分離**による責務の明確化

#### 非同期処理
- **Laravel Queue + Redis**による高性能な非同期処理
- **セッション管理**による実行結果の一時保存
- **ポーリング機能**による実行状況の監視
- **エラーハンドリング**による堅牢性の確保

#### テスト戦略
- **テストピラミッド**に基づく包括的なテスト
- **ユニットテスト**による個別機能の検証
- **Featureテスト**による統合機能の検証
- **Queueシステムテスト**による非同期処理の検証

#### 開発効率化
- **Makefile**による開発コマンドの統一
- **Docker環境**による環境の統一
- **詳細なドキュメント**による開発者体験の向上
- **API仕様書**によるフロントエンド・バックエンド連携の明確化

### 🎯 プロジェクト価値

#### ビジネス価値
- **ワークフロー自動化**による業務効率化
- **AI活用**による高度なテキスト処理
- **PDF処理**による文書管理の自動化
- **非同期処理**による大規模処理の対応

#### 技術的価値
- **スケーラブルなアーキテクチャ**による将来拡張性
- **堅牢なテスト環境**による品質保証
- **包括的なドキュメント**による保守性
- **開発効率化ツール**による開発速度向上

### 🔮 将来の拡張可能性

#### 短期拡張
- **DAG構造**による複雑なワークフロー対応
- **認証機能**によるユーザー管理
- **本番環境対応**による実際の運用

#### 長期拡張
- **AIエージェントノード**による高度なAI処理
- **パフォーマンス最適化**による大規模処理対応
- **監視・ログシステム**による運用管理

### 🏆 プロジェクト成功要因

1. **段階的実装** - Phase 1-5による計画的開発
2. **アーキテクチャ重視** - 保守性・拡張性を考慮した設計
3. **テスト駆動開発** - 品質保証を重視した実装
4. **ドキュメント充実** - 開発者体験を重視した文書化
5. **開発効率化** - Makefile等による開発環境の整備

**🎉 Workflow Appプロジェクトが完全に実装完了しました！** 